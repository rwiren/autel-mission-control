version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # CORE: Telemetry Broker (The "Nervous System")
  # ---------------------------------------------------------------------------
  autel_broker:
    image: eclipse-mosquitto:2
    container_name: autel_broker
    restart: unless-stopped
    # CRITICAL: Explicit port mapping fixes the "random port" issue
    ports:
      - "1883:1883"      # Drone Pushes Telemetry Here
      - "9001:9001"      # WebSockets for Dashboards
    volumes:
      - ../config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log

  # ---------------------------------------------------------------------------
  # CORE: Video Server (The "Eyes")
  # ---------------------------------------------------------------------------
  autel_rtsp:
    image: bluenviron/mediamtx:latest
    container_name: autel_rtsp
    restart: unless-stopped
    ports:
      - "8554:8554"      # RTSP Ingest (Drone Pushes Here)
      - "1935:1935"      # RTMP Ingest (Legacy Support)
      - "8888:8888"      # HLS Output (For Grafana)
      - "8889:8889"      # WebRTC Output (Low Latency)
    volumes:
      - ../config/mediamtx.yml:/mediamtx.yml
    environment:
      - MTX_PROTOCOLS=tcp
      - MTX_WEBRTCADDITIONALHOSTS=0.0.0.0

  # ---------------------------------------------------------------------------
  # PROCESSING: Video DVR (The "Memory")
  # ---------------------------------------------------------------------------
  autel_recorder:
    image: linuxserver/ffmpeg:latest
    container_name: autel_recorder
    restart: unless-stopped
    depends_on:
      - autel_rtsp
    volumes:
      - ../recordings:/data/recordings
    # COMMAND: Pulls RTSP from MediaMTX and writes crash-safe fMP4 chunks
    command: >
      -y -i rtsp://autel_rtsp:8554/live/rtsp-drone1
      -c:v copy -c:a copy
      -f segment -segment_time 900 -segment_format_options movflags=+faststart+frag_keyframe+empty_moov
      -strftime 1 -reset_timestamps 1
      "/data/recordings/mission_%Y-%m-%d_%H-%M-%S.mp4"

  # ---------------------------------------------------------------------------
  # STORAGE: Time-Series Database
  # ---------------------------------------------------------------------------
  autel_influx:
    image: influxdb:2
    container_name: autel_influx
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUX_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUX_PASS}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUX_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUX_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2

  # ---------------------------------------------------------------------------
  # PROCESSING: Telemetry Parser (The "Brain")
  # ---------------------------------------------------------------------------
  autel_telegraf:
    image: telegraf:1.29
    container_name: autel_telegraf
    restart: unless-stopped
    depends_on:
      - autel_influx
      - autel_broker
    environment:
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG}
      - INFLUX_BUCKET=${INFLUX_BUCKET}
    volumes:
      - ../config/telegraf.conf:/etc/telegraf/telegraf.conf:ro

  # ---------------------------------------------------------------------------
  # VISUALIZATION: Dashboard
  # ---------------------------------------------------------------------------
  autel_grafana:
    image: grafana/grafana-oss:latest
    container_name: autel_grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - autel_influx
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASS}
      # Plugins for Map and Video support
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel,pr0ps-trackmap-panel,volkovlabs-image-panel
      - GF_PANELS_DISABLE_SANITIZE_HTML=true
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  mosquitto_data:
  mosquitto_log:
  influxdb_data:
  grafana_data:
