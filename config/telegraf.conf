# ---------------------------------------------------------------------------
# File: config/telegraf.conf
# Version: v0.9.4
# Description: Custom parser for Autel Drone OSD Telemetry
# ---------------------------------------------------------------------------

[agent]
  interval = "1s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "1s"
  flush_jitter = "0s"
  omit_hostname = false

# -------------------------------------------------------
# OUTPUT: InfluxDB
# -------------------------------------------------------
[[outputs.influxdb_v2]]
  urls = ["http://autel_influx:8086"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "$INFLUX_BUCKET"

# -------------------------------------------------------
# INPUT: MQTT (The Autel Listener)
# -------------------------------------------------------
[[inputs.mqtt_consumer]]
  # CRITICAL: Match the topic from your screenshot
  topics = [
    "thing/product/+/osd",
    "thing/product/+/events"
  ]

  # Connection settings matching your Mosquitto container
  servers = ["tcp://autel_broker:1883"]
  
  # Data Format Settings
  data_format = "json"
  
  # CRITICAL: Flatten nested JSON so 'data.capacity_percent' becomes a field
  json_query = "" 
  tag_keys = ["bid"]
  
  # Force these fields to be floats (prevents type conflict errors)
  json_string_fields = ["data_device_list", "data_camera_list"]
